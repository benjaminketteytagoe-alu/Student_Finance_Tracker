<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tests - Student Finance Tracker</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            background: #f8fafc;
        }

        h1 {
            color: #2563eb;
        }

        .test-section {
            background: white;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .test-case {
            padding: 0.75rem;
            margin: 0.5rem 0;
            border-left: 4px solid #e2e8f0;
            background: #f8fafc;
        }

        .test-case.pass {
            border-left-color: #10b981;
            background: #d1fae5;
        }

        .test-case.fail {
            border-left-color: #ef4444;
            background: #fee2e2;
        }

        .test-case h4 {
            margin: 0 0 0.5rem 0;
        }

        .test-result {
            font-size: 0.875rem;
            color: #64748b;
        }

        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            margin-right: 0.5rem;
        }

        button:hover {
            background: #1e40af;
        }

        pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
        }

        .stats {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .stat-box {
            padding: 1rem;
            border-radius: 6px;
            flex: 1;
        }

        .stat-box.total {
            background: #dbeafe;
        }

        .stat-box.pass {
            background: #d1fae5;
        }

        .stat-box.fail {
            background: #fee2e2;
        }
    </style>
</head>

<body>
    <h1> Bs Student Finance Tracker - Test Suite</h1>

    <div class="test-section">
        <h2>Test Controls</h2>
        <button onclick="runAllTests()">Run All Tests</button>
        <button onclick="clearTests()">Clear Results</button>
        <button onclick="location.href='index.html'">Back to App</button>
    </div>

    <div class="stats" id="stats" style="display: none;">
        <div class="stat-box total">
            <strong>Total Tests</strong>
            <div id="stat-total">0</div>
        </div>
        <div class="stat-box pass">
            <strong>Passed</strong>
            <div id="stat-pass">0</div>
        </div>
        <div class="stat-box fail">
            <strong>Failed</strong>
            <div id="stat-fail">0</div>
        </div>
    </div>

    <div id="test-results"></div>

    <script type="module">
        import * as Validators from './scripts/validators.js';
        import * as Search from './scripts/search.js';
        import * as Storage from './scripts/storage.js';

        let testResults = [];

        window.runAllTests = () =>
        {
            testResults = [];
            document.getElementById( 'stats' ).style.display = 'flex';

            testValidators();
            testSearch();
            testStorage();

            displayResults();
        };

        window.clearTests = () =>
        {
            document.getElementById( 'test-results' ).innerHTML = '';
            document.getElementById( 'stats' ).style.display = 'none';
            testResults = [];
        };

        function testValidators ()
        {
            const section = { name: 'Validators', tests: [] };

            // Test description validation
            section.tests.push( {
                name: 'Description - Valid input',
                result: Validators.validate( 'description', 'Lunch at cafeteria' ),
                expected: { valid: true },
                pass: Validators.validate( 'description', 'Lunch at cafeteria' ).valid === true
            } );

            section.tests.push( {
                name: 'Description - Leading spaces (should fail)',
                result: Validators.validate( 'description', '  Lunch' ),
                expected: { valid: false },
                pass: Validators.validate( 'description', '  Lunch' ).valid === false
            } );

            section.tests.push( {
                name: 'Description - Trailing spaces (should fail)',
                result: Validators.validate( 'description', 'Lunch  ' ),
                expected: { valid: false },
                pass: Validators.validate( 'description', 'Lunch  ' ).valid === false
            } );

            section.tests.push( {
                name: 'Description - Duplicate words (should fail)',
                result: Validators.validate( 'description', 'Coffee coffee today' ),
                expected: { valid: false },
                pass: Validators.validate( 'description', 'Coffee coffee today' ).valid === false
            } );

            // Test amount validation
            section.tests.push( {
                name: 'Amount - Valid decimal',
                result: Validators.validate( 'amount', '12.50' ),
                expected: { valid: true },
                pass: Validators.validate( 'amount', '12.50' ).valid === true
            } );

            section.tests.push( {
                name: 'Amount - Valid integer',
                result: Validators.validate( 'amount', '45' ),
                expected: { valid: true },
                pass: Validators.validate( 'amount', '45' ).valid === true
            } );

            section.tests.push( {
                name: 'Amount - Invalid format (should fail)',
                result: Validators.validate( 'amount', '12.5.3' ),
                expected: { valid: false },
                pass: Validators.validate( 'amount', '12.5.3' ).valid === false
            } );

            section.tests.push( {
                name: 'Amount - Too many decimals (should fail)',
                result: Validators.validate( 'amount', '12.567' ),
                expected: { valid: false },
                pass: Validators.validate( 'amount', '12.567' ).valid === false
            } );

            // Test date validation
            section.tests.push( {
                name: 'Date - Valid format',
                result: Validators.validate( 'date', '2025-09-25' ),
                expected: { valid: true },
                pass: Validators.validate( 'date', '2025-09-25' ).valid === true
            } );

            section.tests.push( {
                name: 'Date - Invalid format (should fail)',
                result: Validators.validate( 'date', '25-09-2025' ),
                expected: { valid: false },
                pass: Validators.validate( 'date', '25-09-2025' ).valid === false
            } );

            section.tests.push( {
                name: 'Date - Invalid date (should fail)',
                result: Validators.validate( 'date', '2025-13-45' ),
                expected: { valid: false },
                pass: Validators.validate( 'date', '2025-13-45' ).valid === false
            } );

            // Test category validation
            section.tests.push( {
                name: 'Category - Valid single word',
                result: Validators.validate( 'category', 'Food' ),
                expected: { valid: true },
                pass: Validators.validate( 'category', 'Food' ).valid === true
            } );

            section.tests.push( {
                name: 'Category - Valid with hyphen',
                result: Validators.validate( 'category', 'Food-Drinks' ),
                expected: { valid: true },
                pass: Validators.validate( 'category', 'Food-Drinks' ).valid === true
            } );

            section.tests.push( {
                name: 'Category - Invalid with numbers (should fail)',
                result: Validators.validate( 'category', 'Food123' ),
                expected: { valid: false },
                pass: Validators.validate( 'category', 'Food123' ).valid === false
            } );

            // Test JSON validation
            const validJSON = [
                { id: 'txn_1', description: 'Test', amount: 10, category: 'Food', date: '2025-09-25' }
            ];
            section.tests.push( {
                name: 'JSON - Valid structure',
                result: Validators.validateJSON( validJSON ),
                expected: { valid: true },
                pass: Validators.validateJSON( validJSON ).valid === true
            } );

            const invalidJSON = [
                { id: 'txn_1', description: 'Test' } // Missing fields
            ];
            section.tests.push( {
                name: 'JSON - Missing fields (should fail)',
                result: Validators.validateJSON( invalidJSON ),
                expected: { valid: false },
                pass: Validators.validateJSON( invalidJSON ).valid === false
            } );

            testResults.push( section );
        }

        function testSearch ()
        {
            const section = { name: 'Search & Regex', tests: [] };

            const testData = [
                { id: 1, description: 'Coffee break', category: 'Food', amount: 5.50, date: '2025-09-25' },
                { id: 2, description: 'Tea time', category: 'Food', amount: 3.25, date: '2025-09-26' },
                { id: 3, description: 'Lunch special', category: 'Food', amount: 12.00, date: '2025-09-27' }
            ];

            // Test basic search
            let result = Search.searchTransactions( testData, 'coffee', true );
            section.tests.push( {
                name: 'Search - Case insensitive',
                result: result.length,
                expected: 1,
                pass: result.length === 1
            } );

            // Test regex search
            result = Search.searchTransactions( testData, '/(coffee|tea)/i', false );
            section.tests.push( {
                name: 'Search - Regex pattern (coffee OR tea)',
                result: result.length,
                expected: 2,
                pass: result.length === 2
            } );

            // Test lookahead pattern for cents
            result = Search.searchTransactions( testData, '/\\.\\d{2}\\b/', false );
            section.tests.push( {
                name: 'Search - Advanced regex (cents pattern)',
                result: result.length,
                expected: 2,
                pass: result.length === 2
            } );

            // Test highlight matches
            const highlighted = Search.highlightMatches( 'Coffee break', 'coffee', true );
            section.tests.push( {
                name: 'Highlight - Case insensitive match',
                result: highlighted.includes( '<mark>' ),
                expected: true,
                pass: highlighted.includes( '<mark>' )
            } );

            // Test pattern validation
            const validPattern = Search.testPattern( '/coffee/i' );
            section.tests.push( {
                name: 'Pattern validation - Valid regex',
                result: validPattern.valid,
                expected: true,
                pass: validPattern.valid === true
            } );

            const invalidPattern = Search.testPattern( '/[/' );
            section.tests.push( {
                name: 'Pattern validation - Invalid regex',
                result: invalidPattern.valid,
                expected: false,
                pass: invalidPattern.valid === false
            } );

            testResults.push( section );
        }

        function testStorage ()
        {
            const section = { name: 'Storage', tests: [] };

            // Test set and get
            const testKey = 'test_key';
            const testData = { value: 'test123' };

            Storage.set( testKey, testData );
            const retrieved = Storage.get( testKey );
            section.tests.push( {
                name: 'Storage - Set and Get',
                result: retrieved?.value,
                expected: 'test123',
                pass: retrieved?.value === 'test123'
            } );

            // Test remove
            Storage.remove( testKey );
            const removed = Storage.get( testKey );
            section.tests.push( {
                name: 'Storage - Remove',
                result: removed,
                expected: null,
                pass: removed === null
            } );

            // Test array storage
            const testArray = [ 1, 2, 3, 4, 5 ];
            Storage.set( testKey, testArray );
            const retrievedArray = Storage.get( testKey );
            section.tests.push( {
                name: 'Storage - Array storage',
                result: Array.isArray( retrievedArray ) && retrievedArray.length,
                expected: 5,
                pass: Array.isArray( retrievedArray ) && retrievedArray.length === 5
            } );

            // Cleanup
            Storage.remove( testKey );

            testResults.push( section );
        }

        function displayResults ()
        {
            const container = document.getElementById( 'test-results' );
            container.innerHTML = '';

            let totalTests = 0;
            let passedTests = 0;
            let failedTests = 0;

            testResults.forEach( section =>
            {
                const sectionDiv = document.createElement( 'div' );
                sectionDiv.className = 'test-section';

                const sectionTitle = document.createElement( 'h2' );
                sectionTitle.textContent = section.name;
                sectionDiv.appendChild( sectionTitle );

                section.tests.forEach( test =>
                {
                    totalTests++;
                    if ( test.pass ) passedTests++;
                    else failedTests++;

                    const testDiv = document.createElement( 'div' );
                    testDiv.className = `test-case ${ test.pass ? 'pass' : 'fail' }`;

                    const testTitle = document.createElement( 'h4' );
                    testTitle.textContent = `${ test.pass ? '✓' : '✗' } ${ test.name }`;
                    testDiv.appendChild( testTitle );

                    const testResult = document.createElement( 'div' );
                    testResult.className = 'test-result';
                    testResult.innerHTML = `
                        <strong>Result:</strong> ${ JSON.stringify( test.result ) }<br>
                        <strong>Expected:</strong> ${ JSON.stringify( test.expected ) }
                    `;
                    testDiv.appendChild( testResult );

                    sectionDiv.appendChild( testDiv );
                } );

                container.appendChild( sectionDiv );
            } );

            // Update stats
            document.getElementById( 'stat-total' ).textContent = totalTests;
            document.getElementById( 'stat-pass' ).textContent = passedTests;
            document.getElementById( 'stat-fail' ).textContent = failedTests;
        }
    </script>
</body>

</html>